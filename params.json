{
  "name": "Aptpreferences",
  "tagline": "Android快速持久化框架",
  "body": "# Android快速持久化框架 AptPreferences\r\n\r\n[![Release](https://jitpack.io/v/joyrun/AptPreferences.svg)](https://jitpack.io/#joyrun/AptPreferences)\r\n\r\nAptPreferences是基于面向对象设计的快速持久化框架，目的是为了简化SharePreferences的使用，减少代码的编写。可以非常快速地保存基本类型和对象。AptPreferences是基于APT技术实现，在编译期间实现代码的生成，支持混淆。支持多库，根据不同的用户区分持久化信息。\r\n\r\n### 一、配置项目\r\n##### 配置项目根目录 build.gradle\r\n```\r\nbuildscript {\r\n    repositories {\r\n        jcenter()\r\n    }\r\n    dependencies {\r\n        classpath \"com.android.tools.build:gradle:1.5.0\"\r\n        classpath 'com.neenbedankt.gradle.plugins:android-apt:1.8'\r\n    }\r\n}\r\n\r\nallprojects {\r\n    repositories {\r\n        jcenter()\r\n        maven { url \"https://jitpack.io\" }\r\n    }\r\n}\r\n```\r\n##### 配置app build.gradle\r\n```\r\napply plugin: 'com.android.application'\r\napply plugin: 'com.neenbedankt.android-apt'\r\n\r\n//...\r\ndependencies {\r\n    compile 'com.github.joyrun.AptPreferences:aptpreferences:0.2.3'\r\n    apt 'com.github.joyrun.AptPreferences:aptpreferences-compiler:0.2.3'\r\n}\r\n```\r\n\r\n### 二、定义持久化Javabean\r\n\r\n使用方法非常简单，先编写一个普通带getter、setter的javabean类，在类头部添加@AptPreferences即可：\r\n\r\n```\r\n\r\n@AptPreferences\r\npublic class Settings {\r\n   private long lastOpenAppTimeMillis;\r\n   // 使用commit提交，默认是使用apply提交，配置默认值\r\n   @AptField(commit = true)\r\n   private String useLanguage = \"zh\";\r\n   // 使用preferences的方式保存\r\n   @AptField(preferences = true)\r\n   private Push push;\r\n   // 使用对象的方式保存\r\n   private LoginUser loginUser;\r\n   // 不持久化该字段，仅仅保留在内存\r\n   @AptField(save = false)\r\n   private long lastActionTimeMillis;\r\n\r\n    // ...\r\n\r\n    // get、set方法必须写\r\n}\r\n\r\n```\r\n\r\n\r\n\r\n### 三、注解及使用说明\r\n\r\n我们提供了两个注解@AptPreferences和@AptField(commit = false,save = true,preferences = false)。\r\n\r\n###### @AptPreferences\r\n\r\n被注解的javabean必须为字段实现setter和getter方法；\r\n\r\n###### @AptField\r\n\r\nAptField有三个参数可以配置。\r\n\r\n1. commit：可以配置使用commit还是apply持久化，默认是apply，需要在一些需要立刻保存到文件的可以使用commit方式，比如在退出APP时保存退出的时间。\r\n\r\n2. save：用来声明是否需要持久化这个字段。\r\n\r\n3. preferences：这个属性仅仅适用于对象类型的字段，用来声明这个是以对象的方式保存，还是以preferences的方式保存。如果是true，就可以通过settingsPreference.getPush().isOpenPush()的方式存取。\r\n\r\n\r\n\r\n### 四、初始化\r\n\r\n使用之前要进行初始化，建议在Application进行初始化，需要需要保存对象，还需要实现对象的解析器，这里使用Fastjson作为实例：\r\n\r\n```\r\n\r\npublic class MyApplication extends Application{\r\n   @Override\r\n   public void onCreate() {\r\n       super.onCreate();\r\n       AptPreferencesManager.init(this, new AptParser() {\r\n           @Override\r\n           public Object deserialize(Class clazz, String text) {\r\n               return JSON.parseObject(text,clazz);\r\n           }\r\n           @Override\r\n           public String serialize(Object object) {\r\n               return JSON.toJSONString(object);\r\n           }\r\n       });\r\n   }\r\n}\r\n\r\n```\r\n\r\n\r\n\r\n\r\n\r\n### 五、获取持久化对象\r\n\r\n```\r\n\r\n// 提供一个默认的获取方法\r\n\r\nSettingsPreferences settingsPreference = SettingsPreferences.get(\"name\");\r\n\r\n// 可以根据不用的用户名称获取\r\n\r\nSettingsPreferences settingsPreference = SettingsPreferences.get(\"name\");\r\n\r\n```\r\n\r\n### 六、代码调用\r\n\r\n```\r\n\r\n// 普通类型保存\r\nsettingsPreference.setUseLanguage(\"zh\");\r\nsettingsPreference.setLastOpenAppTimeMillis(System.currentTimeMillis());\r\n// 对象类型保存\r\nSettings.LoginUser loginUser = new Settings.LoginUser();\r\nloginUser.setUsername(\"username\");\r\nloginUser.setPassword(\"password\");\r\nsettingsPreference.setLoginUser(loginUser);\r\n// 对象类型带 @AptField(preferences = true) 注解的保存，相当于把 push相关的放在一个分类\r\nsettingsPreference.getPush().setOpenPush(true);\r\n\r\n\r\n// 获取\r\nString useLanguage = settingsPreference.getUseLanguage();\r\nSettings.LoginUser loginUser1 = settingsPreference.getLoginUser();\r\nboolean openPush = settingsPreference.getPush().isOpenPush();\r\n```\r\n\r\n### 七、默认值\r\n\r\n很多时候我们需要在没有获取到值时使用默认值，SharedPreferences本身也是具备默认值的，所以我们也是支持默认值配置。分析生成的代码可以看到：\r\n\r\n```\r\n\r\n@Override\r\npublic long getLastOpenAppTimeMillis() {\r\n   return mPreferences.getLong(\"lastOpenAppTimeMillis\", super.getLastOpenAppTimeMillis());\r\n}\r\n\r\n```\r\n\r\n如果没有获取到值，会调用父类的方法，那么就可以通过这个方式配置默认值：\r\n\r\n```\r\n\r\n@AptPreferences\r\npublic class Settings {\r\n   // 使用commit提交，默认是使用apply提交，配置默认值\r\n   @AptField(commit = true)\r\n   private String useLanguage = \"zh\";\r\n\r\n   // ...\r\n\r\n}\r\n\r\n```\r\n\r\n\r\n\r\n### 八、详细转换代码\r\n\r\n```\r\n\r\n@AptPreferences\r\npublic class Settings {\r\n   private long lastOpenAppTimeMillis;\r\n   // 使用commit提交，默认是使用apply提交，配置默认值\r\n   @AptField(commit = true)\r\n   private String useLanguage = \"zh\";\r\n   // 使用preferences的方式保存\r\n   @AptField(preferences = true)\r\n   private Push push;\r\n   // 使用对象的方式保存\r\n   private LoginUser loginUser;\r\n   // 不持久化该字段，仅仅保留在内存\r\n   @AptField(save = false)\r\n   private long lastActionTimeMillis;\r\n   public long getLastActionTimeMillis() {\r\n       return lastActionTimeMillis;\r\n   }\r\n   public void setLastActionTimeMillis(long lastActionTimeMillis) {\r\n       this.lastActionTimeMillis = lastActionTimeMillis;\r\n   }\r\n   public LoginUser getLoginUser() {\r\n       return loginUser;\r\n   }\r\n   public void setLoginUser(LoginUser loginUser) {\r\n       this.loginUser = loginUser;\r\n   }\r\n   public long getLastOpenAppTimeMillis() {\r\n       return lastOpenAppTimeMillis;\r\n   }\r\n   public void setLastOpenAppTimeMillis(long lastOpenAppTimeMillis) {\r\n       this.lastOpenAppTimeMillis = lastOpenAppTimeMillis;\r\n   }\r\n   public String getUseLanguage() {\r\n       return useLanguage;\r\n   }\r\n   public void setUseLanguage(String useLanguage) {\r\n       this.useLanguage = useLanguage;\r\n   }\r\n   public Push getPush() {\r\n       return push;\r\n   }\r\n   public void setPush(Push push) {\r\n       this.push = push;\r\n   }\r\n   public static class Push {\r\n       private boolean openPush;\r\n       private boolean vibrate;\r\n       private boolean voice;\r\n       public boolean isOpenPush() {\r\n           return openPush;\r\n       }\r\n       public void setOpenPush(boolean openPush) {\r\n           this.openPush = openPush;\r\n       }\r\n       public boolean isVibrate() {\r\n           return vibrate;\r\n       }\r\n       public void setVibrate(boolean vibrate) {\r\n           this.vibrate = vibrate;\r\n       }\r\n       public boolean isVoice() {\r\n           return voice;\r\n       }\r\n       public void setVoice(boolean voice) {\r\n           this.voice = voice;\r\n       }\r\n   }\r\n   public static class LoginUser implements Serializable{\r\n       public String username;\r\n       public String password;\r\n       public String getUsername() {\r\n           return username;\r\n       }\r\n       public void setUsername(String username) {\r\n           this.username = username;\r\n       }\r\n       public String getPassword() {\r\n           return password;\r\n       }\r\n       public void setPassword(String password) {\r\n           this.password = password;\r\n       }\r\n   }\r\n}\r\n\r\n```\r\n\r\n实际上就是根据上面的代码自动生成带有持久化的代码，可以在这里可以找到\r\n\r\n> app/build/generated/source/apt/debug\r\n\r\n```\r\n\r\npublic final class SettingsPreferences extends Settings {\r\n   public static final Map<String, SettingsPreferences> sMap = new java.util.HashMap<>();\r\n   private final SharedPreferences.Editor mEdit;\r\n   private final SharedPreferences mPreferences;\r\n   private final String mName;\r\n   public SettingsPreferences(String name) {\r\n       mPreferences = AptPreferencesManager.getContext().getSharedPreferences(\"Settings_\" + name, 0);\r\n       mEdit = mPreferences.edit();\r\n       this.mName = name;\r\n       this.setPush(new PushPreferences());\r\n   }\r\n   @Override\r\n   public Settings.LoginUser getLoginUser() {\r\n       String text = mPreferences.getString(\"loginUser\", null);\r\n       Object object = null;\r\n       if (text != null) {\r\n           object = AptPreferencesManager.getAptParser().deserialize(com.thejoyrun.aptpreferences.Settings.LoginUser.class, text);\r\n       }\r\n       if (object != null) {\r\n           return (com.thejoyrun.aptpreferences.Settings.LoginUser) object;\r\n       }\r\n       return super.getLoginUser();\r\n   }\r\n   @Override\r\n   public void setLoginUser(Settings.LoginUser loginUser) {\r\n       mEdit.putString(\"loginUser\", AptPreferencesManager.getAptParser().serialize(loginUser)).apply();\r\n   }\r\n   @Override\r\n   public long getLastOpenAppTimeMillis() {\r\n       return mPreferences.getLong(\"lastOpenAppTimeMillis\", super.getLastOpenAppTimeMillis());\r\n   }\r\n   @Override\r\n   public void setLastOpenAppTimeMillis(long lastOpenAppTimeMillis) {\r\n       mEdit.putLong(\"lastOpenAppTimeMillis\", lastOpenAppTimeMillis).apply();\r\n   }\r\n   @Override\r\n   public String getUseLanguage() {\r\n       return mPreferences.getString(\"useLanguage\", super.getUseLanguage());\r\n   }\r\n   @Override\r\n   public void setUseLanguage(String useLanguage) {\r\n       mEdit.putString(\"useLanguage\", useLanguage).commit();\r\n   }\r\n   public static SettingsPreferences get(String name) {\r\n       if (sMap.containsKey(name)) {\r\n           return sMap.get(name);\r\n       }\r\n       synchronized (sMap) {\r\n           if (!sMap.containsKey(name)) {\r\n               SettingsPreferences preferences = new SettingsPreferences(name);\r\n               sMap.put(name, preferences);\r\n           }\r\n       }\r\n       return sMap.get(name);\r\n   }\r\n   public static SettingsPreferences get() {\r\n       return get(\"\");\r\n   }\r\n   public void clear() {\r\n       mEdit.clear().commit();\r\n       sMap.remove(mName);\r\n   }\r\n   public static void clearAll() {\r\n       java.util.Set<String> keys = sMap.keySet();\r\n       for (String key : keys) {\r\n           sMap.get(key).clear();\r\n       }\r\n   }\r\n   private class PushPreferences extends Settings.Push {\r\n       @Override\r\n       public boolean isOpenPush() {\r\n           return mPreferences.getBoolean(\"Push.openPush\", super.isOpenPush());\r\n       }\r\n       @Override\r\n       public void setOpenPush(boolean openPush) {\r\n           mEdit.putBoolean(\"Push.openPush\", openPush).apply();\r\n       }\r\n       @Override\r\n       public boolean isVibrate() {\r\n           return mPreferences.getBoolean(\"Push.vibrate\", super.isVibrate());\r\n       }\r\n       @Override\r\n       public void setVibrate(boolean vibrate) {\r\n           mEdit.putBoolean(\"Push.vibrate\", vibrate).apply();\r\n       }\r\n       @Override\r\n       public boolean isVoice() {\r\n           return mPreferences.getBoolean(\"Push.voice\", super.isVoice());\r\n       }\r\n       @Override\r\n       public void setVoice(boolean voice) {\r\n           mEdit.putBoolean(\"Push.voice\", voice).apply();\r\n       }\r\n   }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n## License\r\n\r\n    Copyright 2016 Joyrun, Inc.\r\n\r\n    Licensed under the Apache License, Version 2.0 (the \"License\");\r\n    you may not use this file except in compliance with the License.\r\n    You may obtain a copy of the License at\r\n\r\n       http://www.apache.org/licenses/LICENSE-2.0\r\n\r\n    Unless required by applicable law or agreed to in writing, software\r\n    distributed under the License is distributed on an \"AS IS\" BASIS,\r\n    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n    See the License for the specific language governing permissions and\r\n    limitations under the License.\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}